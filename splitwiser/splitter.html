<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Expense Splitter - â‚¹</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-brand': '#63519F',
                        'primary-dark': '#4D3B80',
                        'secondary-brand': '#E8DEFC',
                        'secondary-dark': '#D0C3EB',
                        'text-dark': '#1C1B1F',
                        'text-medium': '#49454F',
                        'text-light': '#79747E',
                        'surface-light': '#F7F2FA',
                        'surface-background': '#FFFFFF',
                        'error': '#B3261E',
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts: Inter and Google Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <!-- html2canvas for image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5g+e9iwTgUBG/z5wsC+wL3QAw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
  apiKey: "AIzaSyB1j3hXvKPFf4ZQOlWgQZU0_bz6fFLbOm8",
  authDomain: "test-splitwiser.firebaseapp.com",
  projectId: "test-splitwiser",
  storageBucket: "test-splitwiser.firebasestorage.app",
  messagingSenderId: "65835544178",
  appId: "1:65835544178:web:e4e9e7d7e0bc24f5381ceb",
  measurementId: "G-29KLDPY75N"
};

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.firebase = { db, doc, getDoc, setDoc, onSnapshot, updateDoc, serverTimestamp, arrayUnion, arrayRemove };
            signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="text-center p-10 font-sans text-error"><h1 class="text-2xl font-bold">Firebase Configuration Error</h1><p class="mt-4">Could not initialize the application. Please check the Firebase configuration object in the HTML's script tag.</p></div>`;
        }
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F7F2FA; color: #1C1B1F; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-content { background-color: #FEF7FF; padding: 24px; width: 90%; max-width: 480px; border-radius: 28px; text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #63519F; animation: spin 1s ease infinite; margin: 1rem auto; } 
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom scrollbar to match the theme */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #E8DEFC; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #63519F; border-radius: 10px; }
        
        .material-symbols-outlined { vertical-align: bottom; font-size: 20px; }
        .permission-denied { opacity: 0.5; pointer-events: none; }
        
        .tab-button {
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: border-color 0.3s, color 0.3s;
            color: var(--text-medium);
        }
        .tab-button.active {
            color: #63519F; 
            border-color: #63519F;
        }
        .tab-button:hover:not(.active) {
            color: #1C1B1F;
        }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <!-- Welcome/Entry Screen -->
    <div id="welcomeScreen" class="max-w-xl mx-auto text-center py-8">
        <div class="bg-surface-background p-6 rounded-2xl shadow-sm">
            <span class="material-symbols-outlined text-primary-brand" style="font-size: 48px;">payments</span>
            <h1 class="text-4xl font-bold text-text-dark mt-2 mb-4">Expense Splitter</h1>
            <p class="text-text-medium mb-8 text-lg max-w-md mx-auto">Welcome! Split bills with friends easily, whether you're solo or in a group.</p>
            <div class="space-y-4">
                <button id="startSoloBtn" class="w-full bg-primary-brand text-white font-semibold py-3 px-6 rounded-full flex items-center justify-center gap-2 hover:bg-primary-dark transition-colors shadow-md hover:shadow-lg">
                    <span class="material-symbols-outlined">rocket_launch</span> Split Bill Solo
                </button>
                <button id="createRoomBtn" class="w-full bg-secondary-brand text-primary-brand font-semibold py-3 px-6 rounded-full flex items-center justify-center gap-2 hover:bg-secondary-dark transition-colors">
                    <span class="material-symbols-outlined">group_add</span> Create a New Room
                </button>
                 <button id="joinRoomBtn" class="w-full border border-primary-brand text-primary-brand font-semibold py-3 px-6 rounded-full flex items-center justify-center gap-2 hover:bg-secondary-brand transition-colors">
                    <span class="material-symbols-outlined">login</span> Join a Room
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main App Container (Initially Hidden) -->
    <div id="appContainer" class="hidden max-w-4xl mx-auto">
        <!-- Room Info Bar -->
        <div id="roomInfoBar" class="hidden mb-6 bg-[#6750A4] text-white p-4 rounded-3xl shadow-lg text-center flex flex-col items-center">
            <div class="w-full flex justify-between items-center mb-3">
                 <button onclick="leaveRoom()" class="text-white opacity-80 hover:opacity-100 transition-opacity"><span class="material-symbols-outlined">arrow_back</span></button>
                 <h2 id="roomNameDisplay" class="text-xl font-bold"></h2>
                 <div class="w-8"></div><!-- Spacer -->
            </div>
            <p id="currentUserDisplay" class="text-secondary-brand text-sm font-medium mb-3"></p>
            <p class="mt-2 text-sm font-light">Room Code:</p>
            <div class="mt-1 bg-black bg-opacity-20 inline-flex items-center p-2 rounded-full">
                <span id="roomCodeDisplay" class="text-2xl font-mono tracking-widest px-4"></span>
                <button onclick="copyRoomCode()" class="ml-2 bg-white text-[#6750A4] rounded-full p-2 flex items-center justify-center hover:bg-gray-200 transition-colors">
                    <span class="material-symbols-outlined">content_copy</span>
                </button>
            </div>
             <p id="permissionStatus" class="text-xs mt-4 bg-black bg-opacity-20 inline-block px-3 py-1 rounded-full"></p>
        </div>

        <!-- Main Content Area -->
        <div class="space-y-6">
            <!-- Friends Section -->
            <section id="friendsSection" class="bg-surface-background p-5 rounded-2xl shadow-sm">
                <h2 class="text-xl font-semibold text-text-dark mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-primary-brand">group</span>Group Members</h2>
                <div id="manualAddFriendSection" class="flex flex-col sm:flex-row gap-3 mb-4">
                    <input type="text" id="friendNameInput" placeholder="Enter friend's name" class="flex-grow bg-surface-light border-none rounded-full px-4 py-2 focus:ring-2 focus:ring-primary-brand">
                    <button id="addFriendBtn" class="bg-primary-brand text-white font-medium py-2 px-5 rounded-full flex items-center justify-center gap-2 hover:bg-primary-dark transition-colors">
                        <span class="material-symbols-outlined">add</span>Add
                    </button>
                </div>
                <div id="friendsListDisplay" class="text-text-dark">
                    <div id="friendsTags" class="flex flex-wrap gap-2 mt-1"></div>
                </div>
            </section>
            
            <!-- Item Input & Bill Details Tabs -->
            <section id="itemInputSection" class="bg-surface-background p-5 rounded-2xl shadow-sm">
                <div class="flex border-b border-gray-200 mb-6">
                    <button id="manualTabBtn" class="tab-button active flex-1 flex items-center justify-center gap-2"><span class="material-symbols-outlined">edit_square</span>Add Manually</button>
                    <button id="ocrTabBtn" class="tab-button flex-1 flex items-center justify-center gap-2"><span class="material-symbols-outlined">document_scanner</span>Upload Bill</button>
                </div>

                <!-- Manual Add Content -->
                <div id="manualItemContent">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="itemNameInput" placeholder="Item Name (e.g., Pizza)" class="bg-surface-light border-none rounded-xl p-3 focus:ring-2 focus:ring-primary-brand">
                        <input type="number" id="itemCostInput" placeholder="Item Cost (â‚¹)" step="0.01" class="bg-surface-light border-none rounded-xl p-3 focus:ring-2 focus:ring-primary-brand">
                    </div>
                    <button id="addItemManuallyBtn" class="w-full bg-primary-brand text-white font-semibold py-3 rounded-full flex items-center justify-center gap-2 hover:bg-primary-dark transition-colors shadow-md">
                        <span class="material-symbols-outlined">add_shopping_cart</span>Add Item
                    </button>
                </div>
                
                <!-- OCR Upload Content -->
                <div id="ocrContent" class="hidden space-y-4">
                    <input type="password" id="openAiApiKeyInput" placeholder="Enter your OpenAI API Key" class="w-full bg-surface-light border-none rounded-xl p-3 focus:ring-2 focus:ring-primary-brand">
                    <div>
                        <input type="file" id="billImageInput" accept="image/png, image/jpeg, image/webp" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-secondary-brand file:text-primary-brand hover:file:bg-secondary-dark cursor-pointer">
                        <img id="billImagePreview" src="#" alt="Bill preview" class="mt-4 rounded-xl max-h-60 w-auto shadow-sm mx-auto" style="display:none;">
                    </div>
                    <button id="processBillBtn" class="w-full bg-primary-brand text-white font-semibold py-3 rounded-full flex items-center justify-center gap-2 hover:bg-primary-dark transition-colors shadow-md" disabled>
                        <span class="material-symbols-outlined">scan</span>Process Image
                    </button>
                </div>
            </section>
            
             <!-- Bill Details Section -->
            <section id="billSection" class="bg-surface-background p-5 rounded-2xl shadow-sm">
                 <h2 class="text-xl font-semibold text-text-dark mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-primary-brand">receipt_long</span>Bill Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="number" id="totalBillInput" placeholder="Total Bill Amount (â‚¹)" step="0.01" class="w-full bg-surface-light border-none rounded-xl p-3 focus:ring-2 focus:ring-primary-brand">
                    <div class="flex gap-2">
                        <input type="number" id="discountValueInput" placeholder="Discount" step="0.01" class="w-full bg-surface-light border-none rounded-xl p-3 focus:ring-2 focus:ring-primary-brand">
                        <select id="discountTypeSelect" class="bg-surface-light border-none rounded-xl p-3 focus:ring-2 focus:ring-primary-brand">
                            <option value="amount">â‚¹</option>
                            <option value="percentage">%</option>
                        </select>
                    </div>
                </div>
            </section>
            
            <!-- Items List Section -->
            <section class="bg-surface-background p-5 rounded-2xl shadow-sm">
                <h2 class="text-xl font-semibold text-text-dark mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-primary-brand">list_alt</span>Items for Splitting</h2>
                <div id="itemsListContainer" class="max-h-[50vh] overflow-y-auto custom-scrollbar space-y-3 p-1">
                    <div id="noItemsMsg" class="flex flex-col items-center justify-center text-center py-8 text-text-medium">
                        <span class="material-symbols-outlined text-6xl text-gray-300">upcoming</span>
                        <p class="mt-2">No items added yet.</p>
                    </div>
                </div>
            </section>
            
            <!-- Calculate Button -->
            <section class="text-center">
                <button id="calculateSplitBtn" class="bg-primary-brand text-white font-semibold py-4 px-10 rounded-full flex items-center justify-center gap-2 hover:bg-primary-dark transition-colors shadow-xl hover:shadow-lg text-lg w-full md:w-auto md:mx-auto">
                    <span class="material-symbols-outlined">calculate</span>Calculate Split
                </button>
            </section>

            <!-- Results Section -->
            <section id="resultsSection" class="bg-secondary-brand p-5 rounded-2xl" style="display: none;">
                <div id="resultsToCapture" class="bg-secondary-brand p-4">
                    <h2 class="text-2xl font-bold text-primary-brand mb-6 text-center flex items-center justify-center gap-2"><span class="material-symbols-outlined">bar_chart</span>Results</h2>
                    <div id="individualSplitsDisplay" class="space-y-3 mb-6"></div>
                    <div id="summaryDisplay" class="text-center p-4 bg-surface-background/50 rounded-xl mt-6">
                        <p id="originalItemizedCostText" class="text-text-dark text-base"></p>
                        <p id="discountAppliedText" class="text-text-dark text-base"></p>
                        <p id="finalItemizedCostText" class="text-text-dark text-lg font-bold mt-2"></p>
                        <p id="unaccountedMoneyText" class="text-lg font-bold mt-1"></p>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button id="generateImageBtn" class="bg-primary-brand text-white font-medium py-3 px-6 rounded-full flex items-center justify-center gap-2 hover:bg-primary-dark transition-colors">
                        <span class="material-symbols-outlined">image</span>Share Results
                    </button>
                </div>
            </section>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="customAlertModal" class="modal">
        <div class="modal-content">
            <p id="modalMessageText" class="text-xl text-text-dark mb-6"></p>
            <button onclick="closeModal('customAlertModal')" class="bg-primary-brand text-white font-medium py-2 px-8 rounded-full">OK</button>
        </div>
    </div>
    <div id="imagePreviewModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-primary-brand mb-4">Generated Split Image</h3>
            <img id="generatedImagePreview" src="#" alt="Generated Split Preview" class="max-w-full h-auto rounded-lg shadow-md border border-gray-200">
            <div class="mt-6 flex justify-center gap-4">
                <button id="downloadImageBtn" class="bg-primary-brand text-white font-medium py-2 px-6 rounded-full">Download</button>
                <button onclick="closeModal('imagePreviewModal')" class="bg-secondary-brand text-primary-brand font-medium py-2 px-6 rounded-full">Close</button>
            </div>
        </div>
    </div>
    <div id="loadingModal" class="modal">
        <div class="modal-content bg-transparent shadow-none">
            <div class="spinner"></div>
        </div>
    </div>
    <div id="inputModal" class="modal">
        <div class="modal-content">
            <h3 id="inputModalTitle" class="text-2xl font-bold text-text-dark mb-2"></h3>
            <p id="inputModalMessage" class="text-text-medium mb-6"></p>
            <input type="text" id="inputModalField" class="w-full mb-6 bg-surface-light border-none rounded-xl p-3 focus:ring-2 focus:ring-primary-brand" style="display:none;">
            <div id="inputModalButtons" class="flex justify-end gap-4"></div>
        </div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.firebase) { return; }

            // --- GLOBAL APP STATE ---
            let AppState = { mode: 'solo', roomId: null, roomUnsubscribe: null, friends: [], items: [], totalBill: 0, discountValue: 0, discountType: 'amount', permissions: { canEdit: true } };
            
            // --- DOM Elements ---
            const welcomeScreen = document.getElementById('welcomeScreen');
            const appContainer = document.getElementById('appContainer');
            const roomInfoBar = document.getElementById('roomInfoBar');
            const roomNameDisplay = document.getElementById('roomNameDisplay');
            const roomCodeDisplay = document.getElementById('roomCodeDisplay');
            const currentUserDisplay = document.getElementById('currentUserDisplay');
            const permissionStatus = document.getElementById('permissionStatus');
            const friendNameInput = document.getElementById('friendNameInput');
            const friendsTagsContainer = document.getElementById('friendsTags');
            const totalBillInput = document.getElementById('totalBillInput');
            const discountValueInput = document.getElementById('discountValueInput');
            const discountTypeSelect = document.getElementById('discountTypeSelect');
            const itemsListContainer = document.getElementById('itemsListContainer');
            const noItemsMsg = document.getElementById('noItemsMsg');
            const manualTabBtn = document.getElementById('manualTabBtn');
            const ocrTabBtn = document.getElementById('ocrTabBtn');
            const manualItemContent = document.getElementById('manualItemContent');
            const ocrContent = document.getElementById('ocrContent');
            const openAiApiKeyInput = document.getElementById('openAiApiKeyInput');
            const billImageInput = document.getElementById('billImageInput');
            const billImagePreview = document.getElementById('billImagePreview');
            const processBillBtn = document.getElementById('processBillBtn');
            const resultsSection = document.getElementById('resultsSection');
            const individualSplitsDisplay = document.getElementById('individualSplitsDisplay');
            const originalItemizedCostText = document.getElementById('originalItemizedCostText');
            const discountAppliedText = document.getElementById('discountAppliedText');
            const finalItemizedCostText = document.getElementById('finalItemizedCostText');
            const unaccountedMoneyText = document.getElementById('unaccountedMoneyText');

            // --- MODAL & UTILITY FUNCTIONS ---
            function showModal(modalId) { document.getElementById(modalId).style.display = "flex"; }
            function closeModal(modalId) { document.getElementById(modalId).style.display = "none"; }
            function showAlert(message) { document.getElementById('modalMessageText').textContent = message; showModal('customAlertModal'); }
            window.closeModal = closeModal;
            window.onclick = function(event) { if (event.target.classList.contains('modal')) closeModal(event.target.id); }

            function showInputModal(options) {
                return new Promise((resolve, reject) => {
                    const modal = document.getElementById('inputModal');
                    const titleEl = document.getElementById('inputModalTitle');
                    const messageEl = document.getElementById('inputModalMessage');
                    const inputEl = document.getElementById('inputModalField');
                    const buttonsEl = document.getElementById('inputModalButtons');

                    titleEl.textContent = options.title || '';
                    messageEl.innerHTML = options.message || '';
                    inputEl.style.display = 'none';
                    buttonsEl.innerHTML = '';

                    const handleCancel = () => { closeModal('inputModal'); reject(new Error('User cancelled')); };
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = options.cancelText || 'Cancel';
                    cancelBtn.className = 'text-primary-brand font-medium py-2 px-4 rounded-full hover:bg-secondary-brand';
                    cancelBtn.onclick = handleCancel;

                    if (options.type === 'prompt') {
                        inputEl.style.display = 'block';
                        inputEl.value = '';
                        inputEl.placeholder = options.placeholder || '';
                        const okBtn = document.createElement('button');
                        okBtn.textContent = options.okText || 'OK';
                        okBtn.className = 'bg-primary-brand text-white font-medium py-2 px-6 rounded-full';
                        okBtn.onclick = () => { closeModal('inputModal'); resolve(inputEl.value); };
                        buttonsEl.append(cancelBtn, okBtn);
                        setTimeout(() => inputEl.focus(), 100);
                    } else if (options.type === 'confirm') {
                        const yesBtn = document.createElement('button');
                        yesBtn.textContent = options.yesText || 'Yes';
                        yesBtn.className = 'bg-primary-brand text-white font-medium py-2 px-6 rounded-full';
                        yesBtn.onclick = () => { closeModal('inputModal'); resolve(true); };
                        buttonsEl.append(cancelBtn, yesBtn);
                    }
                    showModal('inputModal');
                });
            }

            // --- UI RENDERERS ---
            function renderAll() { renderFriends(); renderItemsList(); renderBillDetails(); applyPermissions(); }

            function renderFriends() {
                const currentUserName = sessionStorage.getItem('currentUserName');
                friendsTagsContainer.innerHTML = AppState.friends.length === 0 ? '<p class="text-text-medium text-sm px-2">No friends added yet. You are currently in a solo session.</p>' :
                    AppState.friends.map((friend, index) => {
                        const safeFriendName = friend.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        const isCurrentUser = friend === currentUserName;
                        const isHost = index === 0 && AppState.mode === 'room';
                        const canRemove = (currentUserName === AppState.friends[0] && AppState.mode === 'room') || AppState.mode === 'solo';
                        
                        let friendPill = `<span class="bg-secondary-brand text-primary-brand text-sm font-medium pl-3 pr-2 py-1 rounded-full flex items-center gap-2">`;
                        if (isHost) friendPill += `<span class="material-symbols-outlined text-base">crown</span>`;
                        friendPill += `${safeFriendName}`;
                        if (isCurrentUser) friendPill += ` (You)`;
                        if (canRemove) {
                           friendPill += `<button onclick="removeFriend(${index})" class="text-primary-brand/70 hover:text-primary-brand hover:bg-black/10 rounded-full flex items-center justify-center w-5 h-5 transition-colors"><span class="material-symbols-outlined text-base">close</span></button>`;
                        }
                        friendPill += `</span>`;
                        return friendPill;
                    }).join('');
            }
            
            function renderItemsList() {
                noItemsMsg.style.display = AppState.items.length === 0 ? 'flex' : 'none';
                itemsListContainer.style.display = AppState.items.length > 0 ? 'block' : 'none';

                const currentUserName = sessionStorage.getItem('currentUserName');
                const isHost = AppState.friends.length > 0 && currentUserName === AppState.friends[0];
                const canEdit = AppState.permissions.canEdit || isHost || AppState.mode === 'solo';

                itemsListContainer.innerHTML = AppState.items.map((item, index) => {
                   const safeItemName = item.name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                   const safeSharers = item.sharers.map(s => s.replace(/</g, "&lt;").replace(/>/g, "&gt;")).join(', ');
                   const isUserSharing = item.sharers.includes(currentUserName);
                   const removeButton = canEdit ? `<button onclick="removeItemFromSplit(${index})" class="text-text-light hover:text-error rounded-full p-1 transition-colors"><span class="material-symbols-outlined">delete</span></button>` : '';
                   const selfClaimCheckbox = (AppState.mode === 'room' && currentUserName) ? `<div class="mt-3 pt-3 border-t border-surface-light"><label class="flex items-center cursor-pointer text-primary-brand font-medium"><input type="checkbox" onchange="toggleMyShare(${index})" ${isUserSharing ? 'checked' : ''} class="w-5 h-5 text-primary-brand rounded focus:ring-primary-brand border-2 border-text-light mr-3"><span class="text-sm">I shared this item</span></label></div>` : '';
                   
                   return `<div class="bg-surface-light/70 p-4 rounded-xl">
                                <div class="flex justify-between items-start gap-4">
                                    <div class="flex-grow">
                                        <p class="font-semibold text-text-dark text-base">${safeItemName}</p>
                                        <p class="text-sm text-text-medium mt-1">Shared by: ${safeSharers || 'No one yet'}</p>
                                    </div>
                                    <div class="flex flex-col items-end gap-2">
                                        <p class="text-lg font-bold text-primary-brand whitespace-nowrap">â‚¹${item.cost.toFixed(2)}</p>
                                        ${removeButton}
                                    </div>
                                </div>
                                ${selfClaimCheckbox}
                           </div>`;
                }).join('');
            }

            function renderBillDetails() {
                if (document.activeElement !== totalBillInput) totalBillInput.value = AppState.totalBill || '';
                if (document.activeElement !== discountValueInput) discountValueInput.value = AppState.discountValue || '';
                if (document.activeElement !== discountTypeSelect) discountTypeSelect.value = AppState.discountType;
            }

            function applyPermissions() {
                const currentUserName = sessionStorage.getItem('currentUserName');
                const isHost = AppState.friends.length > 0 && currentUserName === AppState.friends[0];
                const canEdit = AppState.permissions.canEdit || isHost || AppState.mode === 'solo';
                
                const elementsToToggle = [ document.getElementById('manualAddFriendSection'), document.getElementById('billSection'), document.getElementById('itemInputSection') ];
                elementsToToggle.forEach(el => canEdit ? el.classList.remove('permission-denied') : el.classList.add('permission-denied'));

                permissionStatus.textContent = canEdit ? (isHost ? 'You are the Host' : 'Editing is enabled') : 'View-Only Mode';
            }
            
            // --- SESSION MANAGEMENT & NAVIGATION ---
            function startSoloSession() {
                AppState.mode = 'solo'; AppState.roomId = null; AppState.permissions.canEdit = true;
                if (AppState.roomUnsubscribe) AppState.roomUnsubscribe();
                welcomeScreen.style.display = 'none';
                appContainer.style.display = 'block';
                roomInfoBar.style.display = 'none';
                resetLocalState();
                applyPermissions();
                showTab('manual');
            };
            
            async function showCreateRoomPrompt() {
                try {
                    const creatorName = await showInputModal({ type: 'prompt', title: "Create a Room", message: "First, what's your name?", placeholder: "Enter your name", okText: "Next" });
                    if (!creatorName || !creatorName.trim()) return;

                    const roomName = await showInputModal({ type: 'prompt', title: "Name Your Room", message: `Great, ${creatorName}! What should the room be called?`, placeholder: "e.g., Goa Trip", okText: "Create" });
                    if (!roomName || !roomName.trim()) return;

                    const allowEdits = await showInputModal({ type: 'confirm', title: "Set Permissions", message: "Allow others to add/remove items?", yesText: "Yes, Allow All", noText: "No, Host Only" });
                    
                    createRoom(roomName.trim(), creatorName.trim(), allowEdits);
                } catch (error) { console.log("Room creation cancelled."); }
            };

            async function showJoinRoomPrompt() {
                try {
                    const joinerName = await showInputModal({ type: 'prompt', title: "Join a Room", message: "What's your name?", placeholder: "Enter your name", okText: "Next" });
                    if (!joinerName || !joinerName.trim()) return;
                    
                    const roomId = await showInputModal({ type: 'prompt', title: "Enter Room Code", message: "Please enter the 6-character room code.", placeholder: "ABCDEF", okText: "Join" });
                    if (roomId && roomId.trim()) joinRoom(roomId.trim().toUpperCase(), joinerName.trim());
                } catch (error) { console.log("Join room cancelled."); }
            };

            function leaveRoom() {
                if (AppState.mode === 'room' && AppState.roomId) {
                    const currentUserName = sessionStorage.getItem('currentUserName');
                    const { db, doc, updateDoc, arrayRemove } = window.firebase;
                    const roomRef = doc(db, "rooms", AppState.roomId);
                    updateDoc(roomRef, { friends: arrayRemove(currentUserName) });
                }
                if (AppState.roomUnsubscribe) AppState.roomUnsubscribe();
                sessionStorage.removeItem('currentUserName');
                appContainer.style.display = 'none';
                welcomeScreen.style.display = 'block';
                resetLocalState();
            };
            
            function copyRoomCode() { const code = roomCodeDisplay.textContent; navigator.clipboard.writeText(code).then(() => showAlert(`Room Code "${code}" copied!`)).catch(() => showAlert('Failed to copy code.')); }
            function resetLocalState() { AppState = { ...AppState, friends: [], items: [], totalBill: 0, discountValue: 0, discountType: 'amount' }; renderAll(); }

            // --- FIRESTORE INTERACTION ---
            async function createRoom(roomName, creatorName, allowEdits) {
                 if (!window.firebase) { showAlert('Database connection not available.'); return; }
                 const { db, doc, setDoc, serverTimestamp } = window.firebase;
                 const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                 const roomRef = doc(db, "rooms", roomId);
                 showModal('loadingModal');
                 try {
                     await setDoc(roomRef, { roomName, createdAt: serverTimestamp(), friends: [creatorName], items: [], totalBill: 0, discountValue: 0, discountType: 'amount', permissions: { canEdit: allowEdits } });
                     sessionStorage.setItem('currentUserName', creatorName);
                     startListeningToRoom(roomId);
                     showTab('manual');
                 } catch(error) { console.error("Error creating room: ", error); showAlert("Could not create room."); closeModal('loadingModal'); }
            }
            async function joinRoom(roomId, joinerName) {
                if (!window.firebase) { showAlert('Database connection not available.'); return; }
                const { db, doc, getDoc, updateDoc, arrayUnion } = window.firebase;
                const roomRef = doc(db, "rooms", roomId);
                showModal('loadingModal');
                try {
                    const docSnap = await getDoc(roomRef);
                    if (!docSnap.exists()) throw new Error("Room not found.");
                    const roomData = docSnap.data();
                    if (roomData.friends && roomData.friends.includes(joinerName)) {
                        showAlert(`A user named "${joinerName}" is already in this room. Please use a different name.`);
                        closeModal('loadingModal');
                        return;
                    }
                    await updateDoc(roomRef, { friends: arrayUnion(joinerName) });
                    sessionStorage.setItem('currentUserName', joinerName);
                    startListeningToRoom(roomId);
                    showTab('manual');
                } catch(error) { console.error("Error joining room: ", error); showAlert(error.message); closeModal('loadingModal'); }
            }
            function startListeningToRoom(roomId) {
                const { db, doc, onSnapshot } = window.firebase;
                const roomRef = doc(db, "rooms", roomId);
                if (AppState.roomUnsubscribe) AppState.roomUnsubscribe();
                AppState.mode = 'room';
                AppState.roomId = roomId;
                AppState.roomUnsubscribe = onSnapshot(roomRef, (doc) => {
                    const data = doc.data();
                    if (data) {
                        AppState = { ...AppState, ...data };
                        renderAll();
                        roomNameDisplay.textContent = data.roomName;
                        currentUserDisplay.textContent = `You are: ${sessionStorage.getItem('currentUserName')}`;
                    } else {
                        showAlert("The host may have closed the room.");
                        leaveRoom();
                    }
                }, (error) => {
                    console.error("Snapshot listener error:", error);
                    showAlert("Lost connection to the room.");
                    leaveRoom();
                });
                closeModal('loadingModal');
                welcomeScreen.style.display = 'none';
                appContainer.style.display = 'block';
                roomInfoBar.style.display = 'flex';
            }
            async function updateFirestore(newData) {
                 if (AppState.mode !== 'room' || !AppState.roomId) return;
                 const { db, doc, updateDoc } = window.firebase;
                 const roomRef = doc(db, "rooms", AppState.roomId);
                 try { await updateDoc(roomRef, newData); }
                 catch (error) { console.error("Error updating Firestore:", error); showAlert("Could not sync changes."); }
            }
            
            // --- CORE LOGIC FUNCTIONS ---
            function addFriend() { const name = friendNameInput.value.trim(); if (!name) return; if (AppState.friends.includes(name)) { showAlert(`"${name}" is already in the group.`); return; } if (AppState.mode === 'room') updateFirestore({ friends: window.firebase.arrayUnion(name) }); else { AppState.friends.push(name); renderAll(); } friendNameInput.value = ""; };
            function removeFriend(index) { const friendToRemove = AppState.friends[index]; const newFriends = AppState.friends.filter((_, i) => i !== index); const newItems = AppState.items.map(item => ({...item, sharers: item.sharers.filter(s => s !== friendToRemove) })); if (AppState.mode === 'room') updateFirestore({ friends: newFriends, items: newItems }); else { AppState.friends = newFriends; AppState.items = newItems; renderAll(); } };
            function addItemManually() { const name = document.getElementById('itemNameInput').value.trim(); const cost = parseFloat(document.getElementById('itemCostInput').value); if (!name || isNaN(cost) || cost < 0) { showAlert("Please enter a valid item name and cost."); return; } const newItem = { name, cost, sharers: [] }; if (AppState.mode === 'room') updateFirestore({ items: window.firebase.arrayUnion(newItem) }); else { AppState.items.push(newItem); renderItemsList(); } document.getElementById('itemNameInput').value = ""; document.getElementById('itemCostInput').value = ""; };
            function removeItemFromSplit(index) { const itemToRemove = AppState.items[index]; if (AppState.mode === 'room') updateFirestore({ items: window.firebase.arrayRemove(itemToRemove) }); else { AppState.items.splice(index, 1); renderItemsList(); } };
            function toggleMyShare(itemIndex) { const currentUserName = sessionStorage.getItem('currentUserName'); if (!currentUserName || AppState.mode !== 'room') return; const newItems = JSON.parse(JSON.stringify(AppState.items)); const sharers = newItems[itemIndex].sharers; const isUserSharing = sharers.includes(currentUserName); if (isUserSharing) { const userIndex = sharers.indexOf(currentUserName); if (userIndex > -1) sharers.splice(userIndex, 1); } else { sharers.push(currentUserName); } updateFirestore({ items: newItems }); }
            function updateBillDetails() { const newTotalBill = parseFloat(totalBillInput.value) || 0; const newDiscountValue = parseFloat(discountValueInput.value) || 0; const newDiscountType = discountTypeSelect.value; const payload = { totalBill: newTotalBill, discountValue: newDiscountValue, discountType: newDiscountType }; if (AppState.mode === 'room') { if (window.billUpdateTimeout) clearTimeout(window.billUpdateTimeout); window.billUpdateTimeout = setTimeout(() => updateFirestore(payload), 800); } else { AppState = {...AppState, ...payload }; } };
            
            // --- OCR FUNCTIONS ---
            async function processBillImageWithOpenAI() {
                const openAiApiKey = openAiApiKeyInput.value.trim();
                if (!openAiApiKey) { showAlert("Please enter your OpenAI API Key."); return; }
                if (!billImageInput.files[0]) { showAlert("Please select an image file first."); return; }
                
                showModal('loadingModal');
                processBillBtn.disabled = true;
                
                const reader = new FileReader();
                reader.onloadend = async function() {
                    const base64ImageDataWithPrefix = reader.result;
                    const apiUrl = "https://api.openai.com/v1/chat/completions";
                    const prompt = `Analyze this receipt. Extract all purchased items and tax amounts (like GST, VAT, Service Charge, etc.) along with their corresponding costs. For each identified entry, return it in the format "ITEM_NAME - COST". List each item on a new line. Do not include any introductory text, summary, or explanations. If no items or costs are identifiable, respond ONLY with the text "NO_ITEMS_EXTRACTED".`;
                    const payload = { model: "gpt-4o", messages: [{ role: "user", content: [{ type: "text", text: prompt }, { type: "image_url", image_url: { url: base64ImageDataWithPrefix, detail: "high" }}] }], max_tokens: 1000 };
                    
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openAiApiKey}` }, body: JSON.stringify(payload) });
                        if (!response.ok) { 
                            const d = await response.json(); 
                            throw new Error(d.error.message || `HTTP Error ${response.status}`); 
                        }
                        const result = await response.json();
                        const extractedText = result.choices[0].message.content.trim();
                        parseAndAddExtractedItemsToMainList(extractedText);
                    } catch (error) { 
                        showAlert(`OpenAI Error: ${error.message}`); 
                    } finally { 
                        closeModal('loadingModal'); 
                        updateProcessButtonState();
                    }
                };
                reader.readAsDataURL(billImageInput.files[0]);
            }
            function parseAndAddExtractedItemsToMainList(text) {
                if (text.includes("NO_ITEMS_EXTRACTED")) {
                    showAlert("No identifiable items were extracted from the bill. Please try again or add manually.");
                    return;
                }
                const lines = text.split('\n');
                const itemRegex = /^(.*?)\s*-\s*(\d+(\.\d{1,2})?)$/;
                let newItemsFromOCR = [];
                lines.forEach(line => {
                    const match = line.trim().match(itemRegex);
                    if (match) {
                        const name = match[1].trim().replace(/^[^a-zA-Z0-9(]+|[^a-zA-Z0-9)]+$/g, "").trim();
                        const cost = parseFloat(match[2]);
                        if (name && !isNaN(cost) && cost >= 0) {
                            newItemsFromOCR.push({ name, cost, sharers: [] });
                        }
                    }
                });
                if (newItemsFromOCR.length > 0) {
                    const combinedItems = [...AppState.items, ...newItemsFromOCR];
                    if (AppState.mode === 'room') {
                        updateFirestore({ items: combinedItems });
                    } else {
                        AppState.items = combinedItems;
                        renderItemsList(); 
                    }
                    showAlert(`Successfully added ${newItemsFromOCR.length} items from the bill!`);
                } else {
                    showAlert("Could not parse any items from the OCR result. Please check the bill image or add items manually.");
                }
            }
            
            // --- CALCULATE & SHARE ---
            function calculateSplit() {
                if (AppState.friends.length === 0) { showAlert("Please add friends to the group first."); return; }
                if (AppState.items.length === 0) { showAlert("Add at least one item to split."); return; }
                let individualOwes = {}; AppState.friends.forEach(f => individualOwes[f] = 0);
                let originalTotalItemizedCost = AppState.items.reduce((sum, item) => sum + item.cost, 0);
                AppState.items.forEach(item => { if (item.sharers.length > 0) { const costPerSharer = item.cost / item.sharers.length; item.sharers.forEach(sharer => { if (individualOwes.hasOwnProperty(sharer)) individualOwes[sharer] += costPerSharer; }); } });
                let totalDiscountAmount = 0; if (AppState.discountValue > 0 && originalTotalItemizedCost > 0) { totalDiscountAmount = AppState.discountType === 'percentage' ? (originalTotalItemizedCost * AppState.discountValue) / 100 : AppState.discountValue; if (totalDiscountAmount > originalTotalItemizedCost) totalDiscountAmount = originalTotalItemizedCost; }
                let finalTotalItemizedCost = originalTotalItemizedCost - totalDiscountAmount;
                if (originalTotalItemizedCost > 0 && totalDiscountAmount > 0) { AppState.friends.forEach(friend => { const originalShare = individualOwes[friend]; if (originalShare > 0) { const proportionOfTotal = originalShare / originalTotalItemizedCost; const discountForFriend = totalDiscountAmount * proportionOfTotal; individualOwes[friend] = Math.max(0, originalShare - discountForFriend); } }); }
                
                individualSplitsDisplay.innerHTML = AppState.friends.map(friend => `<div class="flex justify-between items-center p-3 bg-surface-background rounded-lg"><span class="font-medium">${friend.replace(/</g, "&lt;")}</span> <span class="font-bold text-green-600">owes â‚¹${(individualOwes[friend] || 0).toFixed(2)}</span></div>`).join('');
                originalItemizedCostText.textContent = `Itemized Total: â‚¹${originalTotalItemizedCost.toFixed(2)}`;
                discountAppliedText.style.display = totalDiscountAmount > 0 ? 'block' : 'none';
                discountAppliedText.textContent = `Discount: -â‚¹${totalDiscountAmount.toFixed(2)}`;
                finalItemizedCostText.textContent = `Final Item Cost: â‚¹${finalTotalItemizedCost.toFixed(2)}`;
                const unaccountedMoney = AppState.totalBill - finalTotalItemizedCost;
                unaccountedMoneyText.textContent = unaccountedMoney.toFixed(2) == 0.00 ? 'The bill is perfectly balanced!' : unaccountedMoney > 0 ? `Unaccounted (Tip/Surplus): â‚¹${unaccountedMoney.toFixed(2)}` : `Shortfall: â‚¹${Math.abs(unaccountedMoney).toFixed(2)}`;
                unaccountedMoneyText.className = `text-lg font-bold mt-1 ${unaccountedMoney > 0 ? 'text-green-600' : unaccountedMoney < 0 ? 'text-error' : 'text-text-medium'}`;
                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
            async function generateAndShowImage() {
                if (resultsSection.style.display === 'none') { showAlert("Calculate split first."); return; }
                const resultsToCapture = document.getElementById('resultsToCapture');
                
                const originalBg = resultsToCapture.style.backgroundColor;
                resultsToCapture.style.backgroundColor = '#E8DEFC'; 
                
                try {
                    const canvas = await html2canvas(resultsToCapture, { scale: 2, useCORS: true, logging: false });
                    resultsToCapture.style.backgroundColor = originalBg; 

                    const imageDataUrl = canvas.toDataURL('image/png');
                    document.getElementById('generatedImagePreview').src = imageDataUrl;
                    document.getElementById('downloadImageBtn').onclick = () => { const link = document.createElement('a'); link.download = 'expense_split.png'; link.href = imageDataUrl; link.click(); };
                    showModal('imagePreviewModal');
                } catch (error) {
                    console.error("Image gen error:", error); showAlert("Error generating image.");
                    resultsToCapture.style.backgroundColor = originalBg; 
                }
            }
            
            function showTab(tabName) {
                [manualTabBtn, ocrTabBtn].forEach(b => b.classList.remove('active'));
                [manualItemContent, ocrContent].forEach(c => c.classList.add('hidden'));
                if (tabName === 'manual') { manualTabBtn.classList.add('active'); manualItemContent.classList.remove('hidden'); } 
                else { ocrTabBtn.classList.add('active'); ocrContent.classList.remove('hidden'); }
            }
            
            // --- EVENT LISTENERS ---
            function updateProcessButtonState() { const canEdit = AppState.permissions.canEdit || (AppState.mode === 'room' && AppState.friends.length > 0 && sessionStorage.getItem('currentUserName') === AppState.friends[0]) || AppState.mode === 'solo'; if (!canEdit) { processBillBtn.disabled = true; return; } processBillBtn.disabled = !openAiApiKeyInput.value.trim() || !billImageInput.files[0]; }
            billImageInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { billImagePreview.src = e.target.result; billImagePreview.style.display = 'block'; }; reader.readAsDataURL(file); } else { billImagePreview.style.display = 'none'; } updateProcessButtonState(); });
            openAiApiKeyInput.addEventListener('input', updateProcessButtonState);
            [totalBillInput, discountValueInput, discountTypeSelect].forEach(el => el.addEventListener('input', updateBillDetails));
            document.getElementById('startSoloBtn').addEventListener('click', startSoloSession);
            document.getElementById('createRoomBtn').addEventListener('click', showCreateRoomPrompt);
            document.getElementById('joinRoomBtn').addEventListener('click', showJoinRoomPrompt);
            document.getElementById('addFriendBtn').addEventListener('click', addFriend);
            document.getElementById('addItemManuallyBtn').addEventListener('click', addItemManually);
            document.getElementById('processBillBtn').addEventListener('click', processBillImageWithOpenAI);
            document.getElementById('calculateSplitBtn').addEventListener('click', calculateSplit);
            document.getElementById('generateImageBtn').addEventListener('click', generateAndShowImage);
            manualTabBtn.addEventListener('click', () => showTab('manual'));
            ocrTabBtn.addEventListener('click', () => showTab('ocr'));
            Object.assign(window, { leaveRoom, copyRoomCode, removeFriend, removeItemFromSplit, toggleMyShare });
            
            renderAll();
            showTab('manual'); 
        });
    </script>
</body>
</html>
