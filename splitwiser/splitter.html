<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Expense Splitter - ‚Çπ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5g+e9iwTgUBG/z5wsC+wL3QAw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // TODO: Replace with your actual Firebase config object
        const firebaseConfig = {
          apiKey: "AIzaSyB1j3hXvKPFf4ZQOlWgQZU0_bz6fFLbOm8",
          authDomain: "test-splitwiser.firebaseapp.com",
          projectId: "test-splitwiser",
          storageBucket: "test-splitwiser.firebasestorage.app",
          messagingSenderId: "65835544178",
          appId: "1:65835544178:web:e4e9e7d7e0bc24f5381ceb",
          measurementId: "G-29KLDPY75N"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            window.firebase = {
                db, doc, getDoc, setDoc, onSnapshot, updateDoc, serverTimestamp, arrayUnion, arrayRemove
            };
            
            signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }

    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 450px; border-radius: 0.5rem; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        input[type="checkbox"] { width: 1.25rem; height: 1.25rem; margin-right: 0.5rem; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; margin: 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .welcome-button { background-color: #1e40af; color: white; }
        .permission-denied { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 p-4 md:p-8">

    <!-- Welcome/Entry Screen -->
    <div id="welcomeScreen" class="max-w-xl mx-auto text-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl">
            <h1 class="text-4xl font-bold text-sky-600">Welcome!</h1>
            <p class="text-slate-500 mt-2 mb-8">How would you like to split the bill?</p>
            <div class="space-y-4">
                <button id="startSoloBtn" class="w-full welcome-button font-bold py-4 px-6 rounded-lg text-lg transition duration-150 shadow-lg hover:shadow-xl transform hover:scale-105">üöÄ Split Bill Solo</button>
                <button id="createRoomBtn" class="w-full welcome-button font-bold py-4 px-6 rounded-lg text-lg transition duration-150 shadow-lg hover:shadow-xl transform hover:scale-105">ü§ù Create a New Room</button>
                <button id="joinRoomBtn" class="w-full welcome-button font-bold py-4 px-6 rounded-lg text-lg transition duration-150 shadow-lg hover:shadow-xl transform hover:scale-105">üö™ Join a Room</button>
            </div>
        </div>
    </div>
    
    <!-- Main App Container (Initially Hidden) -->
    <div id="appContainer" class="hidden max-w-3xl mx-auto">
        <div id="roomInfoBar" class="hidden mb-6 bg-indigo-600 text-white p-4 rounded-lg shadow-lg text-center">
            <h2 id="roomNameDisplay" class="text-2xl font-bold"></h2>
            <p id="currentUserDisplay" class="text-indigo-200 text-sm"></p>
            <p id="permissionStatus" class="text-xs mt-1 bg-indigo-700 inline-block px-2 py-0.5 rounded"></p>
            <p class="mt-2">Share this Room Code with your friends:</p>
            <div class="mt-2 bg-indigo-800 inline-flex items-center p-2 rounded-md">
                <span id="roomCodeDisplay" class="text-2xl font-mono tracking-widest"></span>
                <button id="copyRoomCodeBtn" class="ml-4 bg-indigo-400 hover:bg-indigo-300 text-indigo-900 font-bold py-1 px-3 rounded">Copy</button>
            </div>
             <button id="leaveRoomBtn" class="mt-4 text-sm text-indigo-200 hover:text-white underline">Leave Room & Go Back</button>
        </div>

        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl">
            <header class="mb-8 text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-sky-600">üçΩÔ∏è Group Expense Splitter (‚Çπ)</h1>
                <p id="appSubtitle" class="text-slate-500 mt-2">Split expenses manually or upload a bill image!</p>
            </header>
            
            <section id="friendsSection" class="mb-8 p-6 bg-slate-50 rounded-lg shadow">
                <h2 class="text-2xl font-semibold text-sky-700 mb-4">üë• Group Members</h2>
                <div id="manualAddFriendSection" class="flex flex-col sm:flex-row gap-3 mb-4"><input type="text" id="friendNameInput" placeholder="Enter friend's name" class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500"><button id="addFriendBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg transition">Add Friend</button></div>
                <div id="friendsListDisplay" class="text-slate-600"><p class="font-medium">Current Group:</p><div id="friendsTags" class="flex flex-wrap gap-2 mt-1"></div></div>
            </section>

            <section id="billSection" class="mb-8 p-6 bg-slate-50 rounded-lg shadow">
                <h2 class="text-2xl font-semibold text-sky-700 mb-4">üí∞ Bill & Discount</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="totalBillInput" class="block text-sm font-medium text-slate-700 mb-1">Total Bill Amount (‚Çπ):</label><input type="number" id="totalBillInput" placeholder="0.00" step="0.01" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500"></div>
                    <div><label for="discountValueInput" class="block text-sm font-medium text-slate-700 mb-1">Discount:</label><div class="flex gap-2"><input type="number" id="discountValueInput" placeholder="e.g., 100 or 10" step="0.01" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500"><select id="discountTypeSelect" class="p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-sky-500"><option value="amount">‚Çπ</option><option value="percentage">%</option></select></div><p class="text-xs text-slate-500 mt-1">Applied to itemized costs.</p></div>
                </div>
            </section>

            <section id="ocrSection" class="mb-8 p-6 bg-slate-50 rounded-lg shadow">
                <h2 class="text-2xl font-semibold text-sky-700 mb-4">üìÑ Upload Bill for OpenAI OCR</h2>
                <div class="mb-3">
                    <label for="openAiApiKeyInput" class="block text-sm font-medium text-slate-700 mb-1">OpenAI API Key:</label>
                    <input type="password" id="openAiApiKeyInput" placeholder="Enter your OpenAI API Key" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
                    <p class="text-xs text-slate-500 mt-1">Your API key is used only in your browser and not stored.</p>
                </div>
                <div>
                    <label for="billImageInput" class="block text-sm font-medium text-slate-700 mb-1">Select Bill Image:</label>
                    <input type="file" id="billImageInput" accept="image/png, image/jpeg, image/webp" class="w-full p-2 border border-slate-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200">
                    <img id="billImagePreview" src="#" alt="Bill preview" class="mt-3 rounded-lg max-h-60 w-auto shadow-sm" style="display:none;">
                    <button id="processBillBtn" class="mt-4 w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg transition disabled:opacity-50" disabled>Process Image with OpenAI</button>
                    <div id="ocrRawOutput" class="hidden mt-4 p-2 bg-gray-200 rounded text-xs text-gray-600 whitespace-pre-wrap"></div>
                </div>
            </section>
            
            <section id="reviewExtractedItemsSection" class="mb-8 p-6 bg-indigo-50 rounded-lg shadow" style="display: none;">
                <h2 class="text-2xl font-semibold text-indigo-700 mb-4">üîç Review Extracted Items (incl. Taxes)</h2>
                <div id="extractedItemsReviewContainer" class="space-y-4"></div>
                <p id="noExtractedItemsMsg" class="text-slate-600">No items extracted or all items added.</p>
            </section>

            <section id="manualItemSection" class="mb-8 p-6 bg-slate-50 rounded-lg shadow">
                <h2 class="text-2xl font-semibold text-sky-700 mb-4">üõí Add Item Manually</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div><label for="itemNameInput" class="block text-sm font-medium text-slate-700 mb-1">Item Name:</label><input type="text" id="itemNameInput" placeholder="e.g., Pizza" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500"></div>
                    <div><label for="itemCostInput" class="block text-sm font-medium text-slate-700 mb-1">Item Cost (‚Çπ):</label><input type="number" id="itemCostInput" placeholder="0.00" step="0.01" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500"></div>
                </div>
                <button id="addItemManuallyBtn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg transition">Add Item</button>
            </section>
            
            <section class="mb-8 p-6 bg-slate-50 rounded-lg shadow"><h2 class="text-2xl font-semibold text-sky-700 mb-4">üìã Items Added for Splitting</h2><div id="itemsListContainer" class="max-h-96 overflow-y-auto custom-scrollbar space-y-3"><p id="noItemsMsg" class="text-slate-500">No items added yet.</p></div></section>
            <section class="mb-8 text-center"><button id="calculateSplitBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-10 rounded-lg text-lg transition shadow-lg hover:shadow-xl transform hover:scale-105">üìä Calculate Split!</button></section>
            <section id="resultsSection" class="p-6 bg-sky-50 rounded-lg shadow-inner" style="display: none;"><div id="resultsToCapture"><h2 class="text-2xl font-semibold text-sky-700 mb-6 text-center">üìà Results Breakdown</h2><div id="individualSplitsDisplay" class="space-y-3 mb-6"></div><div id="summaryDisplay" class="text-center p-4 bg-sky-100 rounded-lg"><p id="originalItemizedCostText"></p><p id="discountAppliedText"></p><p id="finalItemizedCostText"></p><p id="unaccountedMoneyText"></p></div></div><div class="mt-8 text-center"><button id="generateImageBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">üñºÔ∏è Share Results Image</button></div></section>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="customAlertModal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('customAlertModal')">√ó</span><p id="modalMessageText" class="text-lg text-slate-700 mb-4"></p><button onclick="closeModal('customAlertModal')" class="mt-4 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-6 rounded-lg transition">OK</button></div></div>
    <div id="imagePreviewModal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('imagePreviewModal')">√ó</span><h3 class="text-xl font-semibold text-sky-700 mb-3">Generated Split Image</h3><p class="text-sm text-slate-600 mb-3">Right-click/long-press to copy or save.</p><img id="generatedImagePreview" src="#" alt="Generated Split Preview"><div class="mt-6"><button id="downloadImageBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition mr-2">Download</button><button onclick="closeModal('imagePreviewModal')" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-6 rounded-lg transition">Close</button></div></div></div>
    <div id="loadingModal" class="modal"><div class="modal-content"><p id="loadingModalText" class="text-lg text-slate-700 mb-2">Processing...</p><div class="spinner"></div></div></div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.firebase) {
                document.getElementById('welcomeScreen').innerHTML = `<div class="bg-white p-8 rounded-xl shadow-2xl text-red-600"><h1 class="text-3xl font-bold">Connection Error</h1><p class="mt-4">Could not connect to the database service.</p><p class="mt-2">Please ensure you have correctly added your Firebase configuration object in the script.</p></div>`;
                return; 
            }

            let AppState = { mode: 'solo', roomId: null, roomUnsubscribe: null, friends: [], items: [], totalBill: 0, discountValue: 0, discountType: 'amount', extractedBillItems: [], permissions: { canEdit: true } };
            
            const welcomeScreen = document.getElementById('welcomeScreen');
            const appContainer = document.getElementById('appContainer');
            const roomInfoBar = document.getElementById('roomInfoBar');
            const roomNameDisplay = document.getElementById('roomNameDisplay');
            const roomCodeDisplay = document.getElementById('roomCodeDisplay');
            const currentUserDisplay = document.getElementById('currentUserDisplay');
            const permissionStatus = document.getElementById('permissionStatus');
            const appSubtitle = document.getElementById('appSubtitle');
            const friendNameInput = document.getElementById('friendNameInput');
            const friendsTagsContainer = document.getElementById('friendsTags');
            const totalBillInput = document.getElementById('totalBillInput');
            const discountValueInput = document.getElementById('discountValueInput');
            const discountTypeSelect = document.getElementById('discountTypeSelect');
            const itemsListContainer = document.getElementById('itemsListContainer');
            const noItemsMsg = document.getElementById('noItemsMsg');
            const manualAddFriendSection = document.getElementById('manualAddFriendSection');
            const ocrSection = document.getElementById('ocrSection');
            const manualItemSection = document.getElementById('manualItemSection');
            const billSection = document.getElementById('billSection');
            const extractedItemsReviewContainer = document.getElementById('extractedItemsReviewContainer');
            const noExtractedItemsMsg = document.getElementById('noExtractedItemsMsg');
            const openAiApiKeyInput = document.getElementById('openAiApiKeyInput');
            const billImageInput = document.getElementById('billImageInput');
            const billImagePreview = document.getElementById('billImagePreview');
            const processBillBtn = document.getElementById('processBillBtn');
            const loadingModalText = document.getElementById('loadingModalText');
            const resultsSection = document.getElementById('resultsSection');
            const individualSplitsDisplay = document.getElementById('individualSplitsDisplay');
            const originalItemizedCostText = document.getElementById('originalItemizedCostText');
            const discountAppliedText = document.getElementById('discountAppliedText');
            const finalItemizedCostText = document.getElementById('finalItemizedCostText');
            const unaccountedMoneyText = document.getElementById('unaccountedMoneyText');
            
            function showModal(modalId) { document.getElementById(modalId).style.display = "block"; }
            function closeModal(modalId) { document.getElementById(modalId).style.display = "none"; }
            function showAlert(message) { document.getElementById('modalMessageText').textContent = message; showModal('customAlertModal'); }
            window.closeModal = closeModal;
            window.onclick = function(event) { if (event.target.classList.contains('modal')) closeModal(event.target.id); }

            function renderAll() {
                renderFriends(); renderItemsList(); renderBillDetails(); renderExtractedItemsForReview(); applyPermissions();
            }

            function renderFriends() {
                const currentUserName = sessionStorage.getItem('currentUserName');
                friendsTagsContainer.innerHTML = AppState.friends.length === 0 ? '<p class="text-slate-500">No friends added yet.</p>' :
                    AppState.friends.map((friend, index) => {
                        const safeFriendName = friend.replace(/</g, "<").replace(/>/g, ">");
                        const isCurrentUser = friend === currentUserName;
                        const isHost = index === 0 && AppState.mode === 'room';
                        let friendPill = `<span class="bg-sky-200 text-sky-800 text-sm font-medium px-3 py-1.5 rounded-full flex items-center shadow-sm">${isHost ? 'üëë' : ''} ${safeFriendName} ${isCurrentUser ? '(You)' : ''}`;
                        if ((currentUserName === AppState.friends[0] && AppState.mode === 'room') || AppState.mode === 'solo') {
                             friendPill += `<button onclick="removeFriend(${index})" class="ml-2 text-sky-600 hover:text-red-500 font-bold text-lg leading-none">√ó</button>`;
                        }
                        friendPill += `</span>`;
                        return friendPill;
                    }).join('');
            }
            
            function renderItemsList() {
                noItemsMsg.style.display = AppState.items.length === 0 ? 'block' : 'none';
                const currentUserName = sessionStorage.getItem('currentUserName');
                const isHost = AppState.mode === 'room' && AppState.friends.length > 0 ? currentUserName === AppState.friends[0] : false;
                const canEdit = AppState.permissions.canEdit || isHost || AppState.mode === 'solo';
                itemsListContainer.innerHTML = AppState.items.map((item, index) => {
                     const safeItemName = item.name.replace(/</g, "<").replace(/>/g, ">");
                     const safeSharers = item.sharers.map(s => s.replace(/</g, "<").replace(/>/g, ">")).join(', ');
                     const isUserSharing = item.sharers.includes(currentUserName);
                     const removeButton = canEdit ? `<button onclick="removeItemFromSplit(${index})" class="text-red-500 hover:text-red-700 font-semibold py-1 px-2 rounded text-sm flex-shrink-0">Remove</button>` : '';
                     const selfClaimCheckbox = (AppState.mode === 'room' && currentUserName) ? `<div class="mt-3 pt-3 border-t border-slate-200"><label class="flex items-center cursor-pointer"><input type="checkbox" onchange="toggleMyShare(${index})" ${isUserSharing ? 'checked' : ''} class="form-checkbox h-5 w-5 text-green-600 rounded focus:ring-green-500"><span class="ml-3 font-semibold text-green-700">I had this</span></label></div>` : '';
                     return `<div class="p-4 bg-white border border-slate-200 rounded-lg shadow-sm"><div class="flex justify-between items-start"><div><p class="font-semibold text-slate-800 text-lg">${safeItemName}</p><p class="text-slate-600 font-bold text-md">‚Çπ${item.cost.toFixed(2)}</p><p class="text-sm text-slate-500 mt-1">Shared by: ${safeSharers || 'No one yet'}</p></div>${removeButton}</div>${selfClaimCheckbox}</div>`;
                }).join('');
            }

            function renderBillDetails() {
                if (document.activeElement !== totalBillInput) totalBillInput.value = AppState.totalBill || '';
                if (document.activeElement !== discountValueInput) discountValueInput.value = AppState.discountValue || '';
                if (document.activeElement !== discountTypeSelect) discountTypeSelect.value = AppState.discountType;
            }
            
            function renderExtractedItemsForReview() {
                document.getElementById('reviewExtractedItemsSection').style.display = AppState.extractedBillItems.length > 0 ? 'block' : 'none';
                noExtractedItemsMsg.style.display = AppState.extractedBillItems.length === 0 ? 'block' : 'none';
                extractedItemsReviewContainer.innerHTML = AppState.extractedBillItems.map((item, index) => {
                    const sanitizedItemName = item.name.replace(/"/g, """);
                    return `<div class="p-4 bg-white border border-indigo-200 rounded-lg shadow-sm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-center">
                            <div><label for="ocr-item-${index}-name" class="text-xs font-medium text-slate-600">Item/Tax Name:</label><input type="text" id="ocr-item-${index}-name" value="${sanitizedItemName}" class="w-full p-2 border border-slate-300 rounded-md text-sm"></div>
                            <div><label for="ocr-item-${index}-cost" class="text-xs font-medium text-slate-600">Cost (‚Çπ):</label><input type="number" id="ocr-item-${index}-cost" value="${item.cost.toFixed(2)}" step="0.01" class="w-full p-2 border border-slate-300 rounded-md text-sm"></div>
                        </div>
                        <div class="mt-4"><button onclick="addExtractedItemToSplit(${index})" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-md text-sm whitespace-nowrap">Add to Split List</button></div>
                    </div>`;
                }).join('');
            }

            function applyPermissions() {
                const currentUserName = sessionStorage.getItem('currentUserName');
                const isHost = AppState.mode === 'room' && AppState.friends.length > 0 ? currentUserName === AppState.friends[0] : false;
                const canEdit = AppState.permissions.canEdit || isHost || AppState.mode === 'solo';
                const sectionsToToggle = [billSection, ocrSection, manualItemSection, manualAddFriendSection];
                const elementsToToggle = [totalBillInput, discountValueInput, discountTypeSelect];
                if (canEdit) {
                    sectionsToToggle.forEach(sec => sec.classList.remove('permission-denied'));
                    elementsToToggle.forEach(el => el.disabled = false);
                    if (permissionStatus) permissionStatus.textContent = isHost ? 'You are the Host (Full Control)' : 'Editing is enabled for all';
                } else {
                    sectionsToToggle.forEach(sec => sec.classList.add('permission-denied'));
                    elementsToToggle.forEach(el => el.disabled = true);
                    if (permissionStatus) permissionStatus.textContent = 'View-Only Mode (Host is managing items)';
                }
            }
            
            function startSoloSession() {
                AppState.mode = 'solo'; AppState.roomId = null; AppState.permissions.canEdit = true;
                if (AppState.roomUnsubscribe) AppState.roomUnsubscribe();
                welcomeScreen.style.display = 'none'; appContainer.style.display = 'block';
                roomInfoBar.style.display = 'none'; appSubtitle.textContent = 'Splitting bill in Solo Mode.';
                resetLocalState(); applyPermissions();
            };
            
            function showCreateRoomPrompt() {
                const creatorName = prompt("First, what is your name?");
                if (!creatorName || !creatorName.trim()) return;
                const roomName = prompt(`Great, ${creatorName}! Now, what should the room be called? (e.g., 'Goa Trip')`);
                if (!roomName || !roomName.trim()) return;
                const allowEdits = confirm("Allow other participants to add/remove items and bill details?\n\nOK = Yes, Allow\nCancel = No, View-Only for them");
                createRoom(roomName.trim(), creatorName.trim(), allowEdits);
            };

            function showJoinRoomPrompt() {
                const joinerName = prompt("First, what is your name?");
                if (!joinerName || !joinerName.trim()) return;
                const roomId = prompt("Enter the 6-character Room Code to join:");
                if (roomId && roomId.trim()) joinRoom(roomId.trim().toUpperCase(), joinerName.trim());
            };

            function leaveRoom() {
                if (AppState.roomUnsubscribe) AppState.roomUnsubscribe();
                sessionStorage.removeItem('currentUserName');
                AppState.mode = 'solo'; AppState.roomId = null;
                appContainer.style.display = 'none'; welcomeScreen.style.display = 'block';
                resetLocalState();
            };
            
            function copyRoomCode() {
                const code = roomCodeDisplay.textContent;
                navigator.clipboard.writeText(code).then(() => {
                    showAlert(`Room Code "${code}" copied!`);
                }).catch(err => {
                    showAlert('Failed to copy code.');
                });
            }

            function resetLocalState() {
                AppState = { ...AppState, friends: [], items: [], totalBill: 0, discountValue: 0, discountType: 'amount', extractedBillItems: [] };
                renderAll();
                resultsSection.style.display = 'none';
                document.getElementById('reviewExtractedItemsSection').style.display = 'none';
            }

            async function createRoom(roomName, creatorName, allowEdits) {
                if (!window.firebase) { showAlert('Database connection not available.'); return; }
                const { db, doc, setDoc, serverTimestamp } = window.firebase;
                const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                const roomRef = doc(db, "rooms", roomId);
                loadingModalText.textContent = 'Creating room...'; showModal('loadingModal');
                try {
                    await setDoc(roomRef, { roomName, createdAt: serverTimestamp(), friends: [creatorName], items: [], totalBill: 0, discountValue: 0, discountType: 'amount', permissions: { canEdit: allowEdits } });
                    sessionStorage.setItem('currentUserName', creatorName);
                    startListeningToRoom(roomId);
                } catch(error) { console.error("Error creating room: ", error); showAlert("Could not create room."); closeModal('loadingModal'); }
            }
            
            async function joinRoom(roomId, joinerName) {
                if (!window.firebase) { showAlert('Database connection not available.'); return; }
                const { db, doc, getDoc, updateDoc, arrayUnion } = window.firebase;
                const roomRef = doc(db, "rooms", roomId);
                loadingModalText.textContent = 'Joining room...'; showModal('loadingModal');
                try {
                    const docSnap = await getDoc(roomRef);
                    if (!docSnap.exists()) throw new Error("Room not found.");
                    const roomData = docSnap.data();
                    if(roomData.friends && roomData.friends.includes(joinerName)) {
                        showAlert(`A user named "${joinerName}" is already in the room. Please use a different name.`);
                        closeModal('loadingModal');
                        return;
                    }
                    await updateDoc(roomRef, { friends: arrayUnion(joinerName) });
                    sessionStorage.setItem('currentUserName', joinerName);
                    startListeningToRoom(roomId);
                } catch(error) { console.error("Error joining room: ", error); showAlert(error.message); closeModal('loadingModal'); }
            }
            
            function startListeningToRoom(roomId) {
                const { db, doc, onSnapshot } = window.firebase;
                const roomRef = doc(db, "rooms", roomId);
                if (AppState.roomUnsubscribe) AppState.roomUnsubscribe();
                AppState.mode = 'room'; AppState.roomId = roomId;
                AppState.roomUnsubscribe = onSnapshot(roomRef, (doc) => {
                    const data = doc.data();
                    if (data) {
                        AppState = { ...AppState, ...data };
                        renderAll();
                        roomNameDisplay.textContent = data.roomName;
                        currentUserDisplay.textContent = `You are: ${sessionStorage.getItem('currentUserName')}`;
                    }
                }, (error) => {
                    console.error("Error with room listener:", error);
                    showAlert("Lost connection to the room.");
                    leaveRoom();
                });
                closeModal('loadingModal');
                welcomeScreen.style.display = 'none'; appContainer.style.display = 'block';
                roomInfoBar.style.display = 'block'; roomCodeDisplay.textContent = roomId;
                appSubtitle.textContent = `You are in a collaborative room.`;
            }

            async function updateFirestore(newData) {
                if (AppState.mode !== 'room' || !AppState.roomId) return;
                const { db, doc, updateDoc } = window.firebase;
                const roomRef = doc(db, "rooms", AppState.roomId);
                try { await updateDoc(roomRef, newData); } 
                catch (error) { console.error("Error updating Firestore:", error); showAlert("Could not sync changes."); }
            }

            function addFriend() {
                const friendName = friendNameInput.value.trim();
                if (!friendName) { showAlert("Please enter a friend's name."); return; }
                if (AppState.friends.includes(friendName)) { showAlert(`"${friendName}" is already in the group.`); return; }
                if (AppState.mode === 'room') { updateFirestore({ friends: window.firebase.arrayUnion(friendName) }); } 
                else { AppState.friends.push(friendName); renderAll(); }
                friendNameInput.value = "";
            };

            function removeFriend(index) {
                const friendToRemove = AppState.friends[index];
                const newFriends = AppState.friends.filter((_, i) => i !== index);
                const newItems = AppState.items.map(item => ({...item, sharers: item.sharers.filter(s => s !== friendToRemove) }));
                if (AppState.mode === 'room') updateFirestore({ friends: newFriends, items: newItems });
                else { AppState.friends = newFriends; AppState.items = newItems; renderAll(); }
            };
            
            function addItemManually() {
                const itemName = document.getElementById('itemNameInput').value.trim();
                const itemCost = parseFloat(document.getElementById('itemCostInput').value);
                if (!itemName || isNaN(itemCost) || itemCost < 0) { showAlert("Please enter valid item name and cost."); return; }
                const newItem = { name: itemName, cost: itemCost, sharers: [] };
                if (AppState.mode === 'room') { updateFirestore({ items: window.firebase.arrayUnion(newItem) }); } 
                else { AppState.items.push(newItem); renderAll(); }
                document.getElementById('itemNameInput').value = ""; document.getElementById('itemCostInput').value = "";
            };
            
            function removeItemFromSplit(index) {
                 const newItems = AppState.items.filter((_, i) => i !== index);
                 if (AppState.mode === 'room') updateFirestore({ items: newItems });
                 else { AppState.items = newItems; renderAll(); }
            };

            function toggleMyShare(itemIndex) {
                const currentUserName = sessionStorage.getItem('currentUserName');
                if (!currentUserName || AppState.mode !== 'room') return;
                const newItems = JSON.parse(JSON.stringify(AppState.items));
                const sharers = newItems[itemIndex].sharers;
                const userIndex = sharers.indexOf(currentUserName);
                if (userIndex > -1) {
                    sharers.splice(userIndex, 1);
                } else { sharers.push(currentUserName); }
                updateFirestore({ items: newItems });
            }
            
            function updateBillDetails() {
                const newTotalBill = parseFloat(totalBillInput.value) || 0;
                const newDiscountValue = parseFloat(discountValueInput.value) || 0;
                const newDiscountType = discountTypeSelect.value;
                const updatePayload = { totalBill: newTotalBill, discountValue: newDiscountValue, discountType: newDiscountType };
                if (AppState.mode === 'room') {
                     if (window.billUpdateTimeout) clearTimeout(window.billUpdateTimeout);
                     window.billUpdateTimeout = setTimeout(() => updateFirestore(updatePayload), 500);
                } else { Object.assign(AppState, updatePayload); }
            };

            async function processBillImageWithOpenAI() {
                const openAiApiKey = openAiApiKeyInput.value.trim();
                if (!openAiApiKey) { showAlert("Please enter your OpenAI API Key."); return; }
                if (!billImageInput.files[0]) { showAlert("Please select an image file first."); return; }
                loadingModalText.textContent = "Processing Bill..."; showModal('loadingModal');
                processBillBtn.disabled = true;
                const reader = new FileReader();
                reader.onloadend = async function() {
                    const base64ImageData = reader.result;
                    const apiUrl = "https://api.openai.com/v1/chat/completions";
                    const prompt = `Analyze this receipt. Extract all purchased items and their individual costs. Also extract any taxes or service charges listed (e.g., GST, CGST, SGST, Service Charge) and their costs. Format each entry on a new line as: ITEM_NAME - COST. Example: 'Masala Dosa - 150.00'. Do not include a total or subtotal line. If you cannot identify any items, respond with only the text "NO_ITEMS_EXTRACTED".`;
                    const payload = { model: "gpt-4o", messages: [{ role: "user", content: [{ type: "text", text: prompt }, { type: "image_url", image_url: { url: base64ImageData }}] }], max_tokens: 1000 };
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openAiApiKey}` }, body: JSON.stringify(payload) });
                        if (!response.ok) { const d = await response.json(); throw new Error(d.error.message || 'API request failed'); }
                        const result = await response.json();
                        const extractedText = result.choices[0].message.content.trim();
                        document.getElementById('ocrRawOutput').textContent = "Raw Output:\n" + extractedText;
                        document.getElementById('ocrRawOutput').style.display = 'block';
                        parseAndDisplayExtractedItems(extractedText);
                    } catch (error) { showAlert(`OpenAI Error: ${error.message}`); } 
                    finally { closeModal('loadingModal'); processBillBtn.disabled = false; }
                };
                reader.readAsDataURL(billImageInput.files[0]);
            }
            
            function parseAndDisplayExtractedItems(text) {
                AppState.extractedBillItems = [];
                if (text === "NO_ITEMS_EXTRACTED") { renderAll(); return; }
                const lines = text.split('\n');
                const itemRegex = /^(.*?)\s*-\s*(\d+(\.\d{1,2})?)$/;
                lines.forEach(line => {
                    const match = line.trim().match(itemRegex);
                    if (match) {
                        const name = match[1].trim().replace(/^[^a-zA-Z0-9(]+|[^a-zA-Z0-9)]+$/g, "").trim();
                        const cost = parseFloat(match[2]);
                        if (name && !isNaN(cost) && cost >= 0) AppState.extractedBillItems.push({ name, cost, sharers: [] });
                    }
                });
                renderAll();
            }
            
            function addExtractedItemToSplit(index) {
                const name = document.getElementById(`ocr-item-${index}-name`).value.trim();
                const cost = parseFloat(document.getElementById(`ocr-item-${index}-cost`).value);
                if (!name || isNaN(cost) || cost < 0) { showAlert("Invalid name or cost."); return; }
                const newItem = { name: name, cost: cost, sharers: [] };
                AppState.extractedBillItems.splice(index, 1);
                const currentItems = AppState.items.concat(newItem);
                if (AppState.mode === 'room') { updateFirestore({ items: currentItems }); } 
                else { AppState.items = currentItems; }
                renderAll();
            }

            function calculateSplit() {
                if (AppState.friends.length === 0) { showAlert("Please add friends to the group before calculating."); return; }
                if (AppState.items.length === 0) { showAlert("Please add at least one item to split."); return; }
                if (!totalBillInput.value) { showAlert("Please enter the final Total Bill Amount from the receipt."); return; }
                let individualOwes = AppState.friends.reduce((acc, friend) => ({ ...acc, [friend]: 0 }), {});
                let originalTotalItemizedCost = AppState.items.reduce((sum, item) => sum + item.cost, 0);
                AppState.items.forEach(item => {
                    if (item.sharers.length > 0) {
                        const costPerSharer = item.cost / item.sharers.length;
                        item.sharers.forEach(sharer => { if (individualOwes.hasOwnProperty(sharer)) individualOwes[sharer] += costPerSharer; });
                    }
                });
                let totalDiscountAmount = 0;
                if (AppState.discountValue > 0 && originalTotalItemizedCost > 0) {
                    totalDiscountAmount = AppState.discountType === 'percentage' ? (originalTotalItemizedCost * AppState.discountValue) / 100 : AppState.discountValue;
                    if (totalDiscountAmount > originalTotalItemizedCost) totalDiscountAmount = originalTotalItemizedCost;
                    AppState.friends.forEach(friend => {
                        const originalShare = Object.values(AppState.items).reduce((total, item) => {
                            if (item.sharers.includes(friend)) {
                                total += item.cost / item.sharers.length;
                            }
                            return total;
                        }, 0);
                        if (originalShare > 0) {
                            const proportionOfTotal = originalShare / originalTotalItemizedCost;
                            const discountForFriend = totalDiscountAmount * proportionOfTotal;
                            individualOwes[friend] = Math.max(0, individualOwes[friend] - discountForFriend);
                        }
                    });
                }
                let finalTotalItemizedCost = Object.values(individualOwes).reduce((sum, owes) => sum + owes, 0);
                individualSplitsDisplay.innerHTML = AppState.friends.map(friend => `<p class="p-3 bg-white border border-slate-200 rounded-md shadow-sm"><span class="font-semibold">${friend.replace(/</g, "<")}</span> owes: <span class="font-bold text-emerald-600">‚Çπ${(individualOwes[friend] || 0).toFixed(2)}</span></p>`).join('');
                originalItemizedCostText.textContent = `Original Itemized Cost: ‚Çπ${originalTotalItemizedCost.toFixed(2)}`;
                discountAppliedText.style.display = totalDiscountAmount > 0 ? 'block' : 'none';
                discountAppliedText.textContent = `Discount Applied: -‚Çπ${totalDiscountAmount.toFixed(2)}`;
                finalItemizedCostText.textContent = `Final Itemized Cost: ‚Çπ${finalTotalItemizedCost.toFixed(2)}`;
                const unaccountedMoney = AppState.totalBill - finalTotalItemizedCost;
                unaccountedMoneyText.innerHTML = `Unaccounted (Tip/Charges?): <span class="font-bold ${unaccountedMoney >= 0 ? 'text-green-600' : 'text-red-600'}">‚Çπ${unaccountedMoney.toFixed(2)}</span>`;
                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            async function generateAndShowImage() {
                if (resultsSection.style.display === 'none') { showAlert("Calculate split first."); return; }
                const resultsToCapture = document.getElementById('resultsToCapture');
                const originalBg = resultsToCapture.style.backgroundColor;
                const originalPadding = resultsToCapture.style.padding;
                resultsToCapture.style.backgroundColor = 'white'; resultsToCapture.style.padding = '20px';
                try {
                    const canvas = await html2canvas(resultsToCapture, { scale: 2, useCORS: true, logging: false });
                    const imageDataUrl = canvas.toDataURL('image/png');
                    document.getElementById('generatedImagePreview').src = imageDataUrl;
                    document.getElementById('downloadImageBtn').onclick = () => { const link = document.createElement('a'); link.download = 'expense_split.png'; link.href = imageDataUrl; link.click(); };
                    showModal('imagePreviewModal');
                } catch (error) { showAlert("Error generating image."); } 
                finally { resultsToCapture.style.backgroundColor = originalBg; resultsToCapture.style.padding = originalPadding; }
            }
            
            // --- EVENT LISTENERS ---
            document.getElementById('startSoloBtn').addEventListener('click', startSoloSession);
            document.getElementById('createRoomBtn').addEventListener('click', showCreateRoomPrompt);
            document.getElementById('joinRoomBtn').addEventListener('click', showJoinRoomPrompt);
            document.getElementById('addFriendBtn').addEventListener('click', addFriend);
            document.getElementById('addItemManuallyBtn').addEventListener('click', addItemManually);
            document.getElementById('processBillBtn').addEventListener('click', processBillImageWithOpenAI);
            document.getElementById('calculateSplitBtn').addEventListener('click', calculateSplit);
            document.getElementById('generateImageBtn').addEventListener('click', generateAndShowImage);
            document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);
            document.getElementById('copyRoomCodeBtn').addEventListener('click', copyRoomCode);
            totalBillInput.addEventListener('input', updateBillDetails);
            discountValueInput.addEventListener('input', updateBillDetails);
            discountTypeSelect.addEventListener('change', updateBillDetails);
            billImageInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { billImagePreview.src = e.target.result; billImagePreview.style.display = 'block'; processBillBtn.disabled = false; };
                    reader.readAsDataURL(file);
                } else { billImagePreview.style.display = 'none'; processBillBtn.disabled = true; }
            });

            // Make functions called by DYNAMICALLY created HTML global
            Object.assign(window, { removeFriend, removeItemFromSplit, toggleMyShare, addExtractedItemToSplit });
        });
    </script>
</body>
</html>
